<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pwc.pwcesg.backoffice.contents.mapper.TopicMapper">

	<!-- 토픽 목록 -->
	<select id="selectTpicValidityList" parameterType="camelcasemap" resultType="camelcasemap">
		SELECT
			TPIC_INFO.TPIC_UID
			, TPIC_INFO.TPIC_NM
			, TPIC_INFO.TPIC_GB_CD
			, ESG_DB.FNCOMMCDNM('TPIC_GB_CD', TPIC_INFO.TPIC_GB_CD) AS TPIC_GB_CD_NM
			, TPIC_INFO.TPIC_MNU_CD /* 토픽메뉴코드 */
			, ESG_DB.FNCOMMCDNM('TPIC_MNU_CD', TPIC_INFO.TPIC_MNU_CD) AS TPIC_MNU_CD_NM
			, TPIC_INFO.RLS_TGT_CD_ARRY
			, TPIC_INFO.USE_YN
			, TPIC_INFO.DP_YN
			, TPIC_INFO.DP_SEQ
			, TPIC_INFO.DP_STT_DT
			, TPIC_INFO.DP_END_DT
			, TPIC_INFO.PIRD_STNG_USE_YN
			, TPIC_INFO.DP_FIX_YN
			, TPIC_INFO.FST_INS_DT
			, TPIC_INFO.FST_INS_ID
			, TPIC_INFO.LST_UPD_DT
			, TPIC_INFO.LST_UPD_ID
		FROM
			ESG_DB.DP_TPIC_INFO TPIC_INFO
		WHERE
			USE_YN = 'Y'
		ORDER BY
			DP_SEQ ASC
	</select>







	<!-- 토픽 관리 목록 조회 -->
	<select id="selectTpicBySearchCondition" parameterType="camelcasemap" resultType="camelcasemap">
		SELECT
		DTI.TPIC_UID /* 토픽채번 */
		, DTI.TPIC_NM /* 토픽명 */
		, DTI.TPIC_GB_CD /* 토픽구분코드 */
		, fnCommCdNm('TPIC_GB_CD', DTI.TPIC_GB_CD) AS TPIC_GB_CD_NM /* 토픽구분코드명 */
		, DTI.TPIC_MNU_CD /* 토픽메뉴코드 */
		, fnCommCdNm('TPIC_MNU_CD', DTI.TPIC_MNU_CD) AS TPIC_MNU_CD_NM /* 토픽메뉴코드명 */
		, DTI.RLS_TGT_CD_ARRY /* 공개대상코드배열 */
		, DTI.USE_YN /* 사용여부 */
		, DTI.DP_YN /* 전시여부 */
		, DTI.DP_SEQ /* 전시순서 */
		, DTI.DP_STT_DT /* 전시시작일 */
		, DTI.DP_END_DT /* 전시종료일 */
		, DTI.PIRD_STNG_USE_YN /* 기간설정사용여부 */
		, DTI.DP_FIX_YN /* 전시고정여부 */
		, DTI.FST_INS_DT /* 최초등록일 */
		, DTI.FST_INS_ID /* 최초등록아이디 */
		, DTI.LST_UPD_DT /* 최종수정일 */
		, DTI.LST_UPD_ID /* 최종수정아이디 */
		, CONCAT(DATE_FORMAT(DTI.DP_STT_DT, '%Y-%m-%d %H:%i:%s')
		,' ~ ', DATE_FORMAT(DTI.DP_END_DT, '%Y-%m-%d %H:%i:%s')) AS DP_STT_END_DTM /* 전시시작종료일시 */
		, CASE DTI.USE_YN
		WHEN 'Y' THEN '예'
		WHEN 'N' THEN '아니요'
		END AS USE_YN_NM /* 사용여부명 */
		, (
		SELECT GROUP_CONCAT(RLS_TGT_CD)
		FROM DP_TPIC_RLS_TGT_INFO
		WHERE TPIC_UID = DTI.TPIC_UID
		GROUP BY TPIC_UID
		) AS RLS_TGT_CDS
		, (
		SELECT GROUP_CONCAT(fnCommCdNm('RLS_TGT_CD', RLS_TGT_CD))
		FROM DP_TPIC_RLS_TGT_INFO
		WHERE TPIC_UID = DTI.TPIC_UID
		GROUP BY TPIC_UID
		) AS RLS_TGT_CD_NMS
		FROM DP_TPIC_INFO DTI /* 토픽정보 */
		<where>
		</where>
	</select>

	<!-- 토픽부가정보 목록 조회-->
	<select id="selectTpicApndByTpicUid" parameterType="string" resultType="camelcasemap">
		SELECT
			DTAI.TPIC_UID /* 토픽채번 */
			, DTAI.TPIC_TP_CD /* 토픽유형코드 */
			, DTAI.SEQ_NO /* 순번 */
			, DTAI.SUMRY_COMNT /* 요약설명 */
			, DTAI.APND_TTL /* 부가제목 */
			, DTAI.APND_CN /* 부가내용 */
			, DTAI.SPCAL_NM /* 전문가명 */
			, DTAI.SPCAL_POS_NM /* 전문가직급명 */
			, DTAI.SPCAL_MAIL /* 전문가이메일 */
			, DTAI.SPCAL_TELNO /* 전문가전번 */
			, DTAI.FST_INS_DT /* 최초등록일 */
			, DTAI.FST_INS_ID /* 최초등록아이디 */
			, DTAI.LST_UPD_DT /* 최종수정일 */
			, DTAI.LST_UPD_ID /* 최종수정아이디 */
		FROM
			DP_TPIC_APND_INFO DTAI /* 토픽부가정보 */
		WHERE
			DTAI.TPIC_UID = #{tpicUid}
	</select>

	<!-- 토픽공개대상정보 목록 조회-->
	<select id="selectTpicRlsTgtByTpicUid" parameterType="string" resultType="camelcasemap">
		SELECT
			DTRTI.TPIC_UID /* 토픽채번 */
			, DTRTI.RLS_TGT_CD /* 공개대상코드 */
			, DTRTI.FST_INS_DT /* 최초등록일 */
			, DTRTI.FST_INS_ID /* 최초등록아이디 */
		FROM
			DP_TPIC_RLS_TGT_INFO DTRTI /* 토픽공개대상정보 */
		WHERE
			DTRTI.TPIC_UID = #{tpicUid}
	</select>

	<!-- 토픽 관리 상세 조회 -->
	<select id="selectTpicByTpicUid" parameterType="string" resultType="camelcasemap">
		SELECT
			DTI.TPIC_UID /* 토픽채번 */
			, DTI.TPIC_NM /* 토픽명 */
			, DTI.TPIC_GB_CD /* 토픽구분코드 */
			, DTI.TPIC_MNU_CD /* 토픽메뉴코드 */
			, DTI.RLS_TGT_CD_ARRY /* 공개대상코드배열 */
			, DTI.USE_YN /* 사용여부 */
			, DTI.DP_YN /* 전시여부 */
			, DTI.DP_SEQ /* 전시순서 */
			, DTI.DP_STT_DT /* 전시시작일 */
			, DTI.DP_END_DT /* 전시종료일 */
			, DATE_FORMAT(DTI.DP_STT_DT, '%Y-%m-%d') AS DP_STT_DTE /* 전시시작일 */
			, DATE_FORMAT(DTI.DP_STT_DT, '%H') AS DP_STT_HH /* 전시시작일 */
			, DATE_FORMAT(DTI.DP_STT_DT, '%i') AS DP_STT_MI /* 전시시작일 */
			, DATE_FORMAT(DTI.DP_END_DT, '%Y-%m-%d') AS DP_END_DTE /* 전시종료일 */
			, DATE_FORMAT(DTI.DP_END_DT, '%H') AS DP_END_HH /* 전시종료일 */
			, DATE_FORMAT(DTI.DP_END_DT, '%i') AS DP_END_MI /* 전시종료일 */
			, DTI.PIRD_STNG_USE_YN /* 기간설정사용여부 */
			, DTI.DP_FIX_YN /* 전시고정여부 */
			, DTI.FST_INS_DT /* 최초등록일 */
			, DTI.FST_INS_ID /* 최초등록아이디 */
			, DTI.LST_UPD_DT /* 최종수정일 */
			, DTI.LST_UPD_ID /* 최종수정아이디 */
		FROM
			DP_TPIC_INFO DTI /* 토픽정보 */
		WHERE
			DTI.TPIC_UID = #{tpicUid} /* 회원채번 */
	</select>

	<insert id="insertTpicInfo" parameterType="camelcasemap">
		/* order="BEFORE" 삽입 전에 조회 */
		/* selectKey 구문의 위치는 INSERT 쿼리 위, 아래 상관 없이 위치할 수 있습니다. */
		<selectKey keyProperty="tpicUid" resultType="int" order="BEFORE">
			SELECT NEXTVAL('DP_TPIC_INFO_SQ01')
		</selectKey>

		INSERT INTO DP_TPIC_INFO /* 토픽정보 */
		(
		TPIC_UID /* 토픽채번 */
		, TPIC_NM /* 토픽명 */
		, TPIC_GB_CD /* 토픽구분코드 */
		, TPIC_MNU_CD /* 토픽메뉴코드 */
		, RLS_TGT_CD_ARRY /* 공개대상코드배열 */
		, USE_YN /* 사용여부 */
		, DP_YN /* 전시여부 */
		, DP_SEQ /* 전시순서 */
		, DP_STT_DT /* 전시시작일 */
		, DP_END_DT /* 전시종료일 */
		, PIRD_STNG_USE_YN /* 기간설정사용여부 */
		, DP_FIX_YN /* 전시고정여부 */
		, FST_INS_DT /* 최초등록일 */
		, FST_INS_ID /* 최초등록아이디 */
		, LST_UPD_DT /* 최종수정일 */
		, LST_UPD_ID /* 최종수정아이디 */
		) VALUES (
		#{tpicUid} /* 토픽채번 */
		, #{tpicNm} /* 토픽명 */
		, #{tpicGbCd} /* 토픽구분코드 */
		, #{tpicMnuCd} /* 토픽메뉴코드 */
		, '' /* 공개대상코드배열 */
		, #{useYn} /* 사용여부 */
		, 'N' /* 전시여부 */
		, 0 /* 전시순서 */
		, STR_TO_DATE(CONCAT(#{dpSttDte}, #{dpSttHh}, #{dpSttMi}), '%Y-%m-%d%H%i%s') /* 전시시작일 */
		, STR_TO_DATE(CONCAT(#{dpEndDte}, #{dpEndHh}, #{dpEndMi}), '%Y-%m-%d%H%i%s') /* 전시종료일 */
		, #{pirdStngUseYn} /* 기간설정사용여부 */
		, 'N' /* 전시고정여부 */
		, CURRENT_TIMESTAMP /* 최초등록일 */
		, 'ADMIN' /* 최초등록아이디 fstInsId */
		, CURRENT_TIMESTAMP /* 최종수정일 */
		, 'ADMIN' /* 최종수정아이디 lstUpdId */
		)
	</insert>

	<update id="updateTpicInfo" parameterType="camelcasemap">
		UPDATE DP_TPIC_INFO
		SET
			TPIC_NM = #{tpicNm} /* 토픽명 */
			, TPIC_GB_CD = #{tpicGbCd} /* 토픽구분코드 */
			, TPIC_MNU_CD = #{tpicMnuCd} /* 토픽메뉴코드 */
			, USE_YN = #{useYn} /* 사용여부 */
			, DP_STT_DT = STR_TO_DATE(CONCAT(#{dpSttDte}, #{dpSttHh}, #{dpSttMi}),
									  '%Y-%m-%d%H%i%s') /* 전시시작일 */
			, DP_END_DT = STR_TO_DATE(CONCAT(#{dpEndDte}, #{dpEndHh}, #{dpEndMi}),
									  '%Y-%m-%d%H%i%s') /* 전시종료일 */
			, PIRD_STNG_USE_YN = 'N' /* 기간설정사용여부 pirdStngUseYn */
			, LST_UPD_DT = CURRENT_TIMESTAMP /* 최종수정일 */
			, LST_UPD_ID = 'ADMIN' /* 최종수정아이디 */
		WHERE
			TPIC_UID = #{tpicUid} /* 토픽채번 */
	</update>

	<delete id="deleteTpicRlsTgtInfo" parameterType="string">
		DELETE
		FROM
			DP_TPIC_RLS_TGT_INFO
		WHERE
			TPIC_UID = #{tpicUid}
	</delete>

	<insert id="insertTpicRlsTgtInfo" parameterType="camelcasemap">
		/* 공개대상정보 */
		INSERT INTO DP_TPIC_RLS_TGT_INFO (
		TPIC_UID /* 콘텐츠채번 */
		, RLS_TGT_CD /* 공개대상코드 */
		, FST_INS_DT /* 최초등록일 */
		, FST_INS_ID /* 최초등록아이디 */
		) VALUES
		<foreach item="item" index="index" collection="rlsTgtCd" separator=",">
			(
			#{tpicUid}
			, #{item}
			, CURRENT_TIMESTAMP
			, 'ADMIN'
			)
		</foreach>
	</insert>

	<insert id="upsertTpicApndInfo" parameterType="java.util.List">
		INSERT INTO DP_TPIC_APND_INFO (
		TPIC_UID /* 토픽채번 */
		, TPIC_TP_CD /* 토픽유형코드 */
		, SEQ_NO /* 순번 */
		, SUMRY_COMNT /* 요약설명 */
		, APND_TTL /* 부가제목 */
		, APND_CN /* 부가내용 */
		, SPCAL_NM /* 전문가명 */
		, SPCAL_POS_NM /* 전문가직급명 */
		, SPCAL_MAIL /* 전문가이메일 */
		, SPCAL_TELNO /* 전문가전번 */
		, FST_INS_DT /* 최초등록일 */
		, FST_INS_ID /* 최초등록아이디 */
		, LST_UPD_DT /* 최종수정일 */
		, LST_UPD_ID /* 최종수정아이디 */
		) VALUES
		<foreach item="item" index="index" collection="list" separator=",">
			(
			#{item.tpicUid} /* 토픽채번 */
			, #{item.tpicTpCd} /* 토픽유형코드 */
			, #{item.seqNo} /* 순번 */
			, #{item.sumryComnt} /* 요약설명 */
			, #{item.apndTtl} /* 부가제목 */
			, #{item.apndCn} /* 부가내용 */
			, #{item.spcalNm} /* 전문가명 */
			, #{item.spcalPosNm} /* 전문가직급명 */
			, #{item.spcalMail} /* 전문가이메일 */
			, #{item.spcalTelno} /* 전문가전번 */
			, CURRENT_TIMESTAMP
			, 'ADMIN'
			, CURRENT_TIMESTAMP
			, 'ADMIN'
			)
		</foreach>
		ON DUPLICATE KEY
		UPDATE
		SUMRY_COMNT = values(SUMRY_COMNT) /* 요약설명 */
		, APND_TTL = values(APND_TTL) /* 부가제목 */
		, APND_CN = values(APND_CN) /* 부가내용 */
		, SPCAL_NM = values(SPCAL_NM) /* 전문가명 */
		, SPCAL_POS_NM = values(SPCAL_POS_NM) /* 전문가직급명 */
		, SPCAL_MAIL = values(SPCAL_MAIL) /* 전문가이메일 */
		, SPCAL_TELNO = values(SPCAL_TELNO) /* 전문가전번 */
		, LST_UPD_DT = CURRENT_TIMESTAMP /* 최종수정일 */
		, LST_UPD_ID = 'ADMIN' /* 최종수정아이디 */
	</insert>

	<select id="selectTpicByTpicGbCdAndTpicMnuCd" parameterType="camelcasemap"
		resultType="camelcasemap">
		SELECT
			DTI.TPIC_UID /* 토픽채번 */
			, DTI.TPIC_NM /* 토픽명 */
			, DTI.TPIC_GB_CD /* 토픽구분코드 */
			, FNCOMMCDNM('TPIC_GB_CD', DTI.TPIC_GB_CD) AS TPIC_GB_CD_NM /* 토픽구분코드명 */
			, DTI.TPIC_MNU_CD /* 토픽메뉴코드 */
			, FNCOMMCDNM('TPIC_MNU_CD', DTI.TPIC_MNU_CD) AS TPIC_MNU_CD_NM /* 토픽메뉴코드명 */
			, DTI.RLS_TGT_CD_ARRY /* 공개대상코드배열 */
			, DTI.USE_YN /* 사용여부 */
			, DTI.DP_YN /* 전시여부 */
			, DTI.DP_SEQ /* 전시순서 */
			, DTI.DP_STT_DT /* 전시시작일 */
			, DTI.DP_END_DT /* 전시종료일 */
			, DTI.PIRD_STNG_USE_YN /* 기간설정사용여부 */
			, DTI.DP_FIX_YN /* 전시고정여부 */
			, DTI.FST_INS_DT /* 최초등록일 */
			, DTI.FST_INS_ID /* 최초등록아이디 */
			, DTI.LST_UPD_DT /* 최종수정일 */
			, DTI.LST_UPD_ID /* 최종수정아이디 */
			, CONCAT(DATE_FORMAT(DTI.DP_STT_DT, '%Y-%m-%d %H:%i:%s')
				, ' ~ ',
					 DATE_FORMAT(DTI.DP_END_DT, '%Y-%m-%d %H:%i:%s')) AS DP_STT_END_DTM /* 전시시작종료일시 */
			, CASE DTI.USE_YN
				  WHEN 'Y' THEN '예'
				  WHEN 'N' THEN '아니요'
				END AS USE_YN_NM /* 사용여부명 */
			, (SELECT
				   GROUP_CONCAT(RLS_TGT_CD)
			   FROM
				   DP_TPIC_RLS_TGT_INFO
			   WHERE
				   TPIC_UID = DTI.TPIC_UID
			   GROUP BY
				   TPIC_UID) AS RLS_TGT_CDS
			, (SELECT
				   GROUP_CONCAT(FNCOMMCDNM('RLS_TGT_CD', RLS_TGT_CD))
			   FROM
				   DP_TPIC_RLS_TGT_INFO
			   WHERE
				   TPIC_UID = DTI.TPIC_UID
			   GROUP BY
				   TPIC_UID) AS RLS_TGT_CD_NMS
		FROM
			DP_TPIC_INFO DTI /* 토픽정보 */
		WHERE
			DTI.TPIC_GB_CD = #{tpicGbCd}
			AND DTI.TPIC_MNU_CD = #{tpicMnuCd}
	</select>

<!--	=========================================================================================-->
<!--	DELETEED ================================================================================-->
<!--	=========================================================================================-->

</mapper>