<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pwc.pwcesg.backoffice.contents.mapper.NewsTrendMngMapper">
    <!-- 뉴스 트렌드 키워드 관리 목록 조회 -->
    <select id="selectNewsTrendKeywordList" parameterType="camelcasemap" resultType="camelcasemap">
        SELECT
            ROW_NUMBER() OVER (ORDER BY WEIGHT DESC)             AS ROW_NUM
            , KEYWORD_UID
            , BASE_DATE
            , NAME
            , WEIGHT
            , (
                SELECT TOP 1
                    TITLE
                FROM
                    ESG_DB.NWS_NEWS
                WHERE
                    PROVIDER_LINK_PAGE IS NOT NULL
                    AND TRIM(PROVIDER_LINK_PAGE) <![CDATA[<>]]> ''
                    AND KEYWORD_UID = NK.KEYWORD_UID
                ORDER BY ORDER_NO
            )                                  AS REPRESENTATIVE_NEWS_TITLE
            , ISNULL(DP_YN, 'Y')                                   AS DP_YN
            , FORMAT(DATEADD(HOUR, 9, REG_DT), 'yyyy.MM.dd HH:mm') AS REG_DT
        FROM
            ESG_DB.NWS_KEYWORD NK
        WHERE
            BASE_DATE = (SELECT MAX(BASE_DATE) FROM ESG_DB.NWS_KEYWORD)
        ORDER BY
            WEIGHT DESC
    </select>

    <!-- 뉴스 트렌드 키워드별 뉴스 목록 조회 -->
    <select id="selectNewsTrendNewsList" parameterType="camelcasemap" resultType="camelcasemap">
        SELECT ROW_NUMBER() OVER (ORDER BY ORDER_NO)     AS ROW_NUM
             , NEWS_UID
             , KEYWORD_UID
             , ORDER_NO
             , TITLE
             , REPLACE(LEFT(PUBLISHED_AT, 10), '-', '.') AS PUBLISHED_DT
             , PROVIDER
             , PROVIDER_LINK_PAGE
             , ISNULL(DP_YN, 'Y')                        AS DP_YN
        FROM ESG_DB.NWS_NEWS
        WHERE 1 = 1
          AND TRIM(PROVIDER_LINK_PAGE) <![CDATA[<>]]> ''
          AND KEYWORD_UID = #{keywordUid}
        ORDER BY ORDER_NO
    </select>

    <!-- 뉴스 트렌드 뉴스 키워드 갱신 -->
    <update id="updateNewsTrendKeyword" parameterType="camelcasemap">
        UPDATE
            ESG_DB.NWS_KEYWORD
        SET
            DP_YN = #{dpYn}
        WHERE
            KEYWORD_UID=#{keywordUid}
    </update>

    <!-- 뉴스 트렌드 뉴스 갱신 -->
    <update id="updateNewsTrendNews" parameterType="camelcasemap">
        UPDATE
            ESG_DB.NWS_NEWS
        SET
            DP_YN = #{dpYn}
        WHERE
            NEWS_UID=#{newsUid}
    </update>

</mapper>
