<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pwc.pwcesg.backoffice.contents.mapper.NewsMapper">
	
	<!-- 신규 뉴스 관리 목록 조회 -->
	<select id="selectNewsList" parameterType="camelcasemap" resultType="camelcasemap">
		SELECT
			SCI.CONT_UID /* 콘텐츠채번 */
			, SCI.CONT_KIND_CD /* 콘텐츠종류코드 */
			, ESG_DB.fnCommCdNm('CONT_KIND_CD', SCI.CONT_KIND_CD) AS CONT_KIND_CD_NM /* 콘텐츠종류코드명 */
			, SCI.CONT_ST_CD /* 콘텐츠상태코드 */
			, ESG_DB.fnCommCdNm('CONT_ST_CD', SCI.CONT_ST_CD) AS CONT_ST_CD_NM /* 콘텐츠상태코드명 */
			, SCI.CONT_UNO /* 콘텐츠고유번호 */
			, SCI.CONT_NM /* 콘텐츠명 */
		    , FORMAT(BRI.PBLCN_DT, 'yyyy.MM.dd HH:dd:ss') AS PBLCN_DT
			, SCI.SRC_UID /* 출처채번 */
			, SSI.SRC_NM /* 출처 */
		    , BRI.WRTR_NM
			, SCI.SBJT_GB_CD /* 주제분류코드 */
			, ESG_DB.fnCommCdNm('SBJT_GB_CD', SCI.SBJT_GB_CD) AS SBJT_GB_CD_NM /* 주제분류코드명 */
			, SCI.TASK_CLSF_CD /* 업무분류코드 */
			, ESG_DB.fnCommCdNm('TASK_CLSF_CD', SCI.TASK_CLSF_CD) AS TASK_CLSF_CD_NM /* 업무분류코드명 */
			, SCI.DP_TP_CD /* 전시유형코드 */
			, ESG_DB.fnCommCdNm('DP_TP_CD', DP_TP_CD) AS DP_TP_CD_NM /* 전시유형코드명 */
			, SCI.RLS_TGT_CD_ARRY /* 공개대상코드배열 */
			, ESG_DB.fnGetCdNmArry('MBR_GB_CD', SCI.RLS_TGT_CD_ARRY, SCI.CONT_UID) AS RLS_TGT_CD_NM_ARRY	/* 공개대상코드명배열 */
			, SCI.SRCH_PSBLTY_YN /* 검색가능여부 */
			, CASE SCI.SRCH_PSBLTY_YN
				WHEN 'Y' THEN N'가능'
				WHEN 'N' THEN N'불가'
			END AS SRCH_PSBLTY_YN_NM /* 검색가능여부 */
			, (
				SELECT
					STRING_AGG(DTI.TPIC_NM, ', ') WITHIN GROUP (ORDER BY DTI.DP_SEQ)
				FROM
					ESG_DB.DP_CONT_TPIC_INFO DCTI
					LEFT JOIN ESG_DB.DP_TPIC_INFO DTI
						ON DTI.TPIC_UID = DCTI.TPIC_UID
				WHERE
					DCTI.CONT_UID = SCI.CONT_UID
			) AS TPIC_NM_ARRY /* 토픽명배열 */
			, FORMAT(DATEADD(HOUR, 9, SCI.FST_INS_DT), 'yyyy.MM.dd') AS FST_INS_DT /* 등록일 */
			, (SELECT MBR_NM FROM ESG_DB.MB_MBR_INFO WHERE MBR_ID = SCI.FST_INS_ID) AS FST_INS_MBR_NM /* 등록자 */
			, FORMAT(DATEADD(HOUR, 9, SCI.LST_UPD_DT), 'yyyy.MM.dd') AS LST_UPD_DT /* 수정일 */
			, (SELECT MBR_NM FROM ESG_DB.MB_MBR_INFO WHERE MBR_ID = SCI.LST_UPD_ID) AS LST_UPD_MBR_NM /* 수정자 */
		FROM
			ESG_DB.ST_CONT_INFO SCI
			JOIN ESG_DB.BT_RSS_INFO BRI
				ON BRI.LINK_URL = SCI.LINK_URL
			LEFT JOIN ESG_DB.ST_CONT_APND_INFO SCAI
				ON SCAI.CONT_UID = SCI.CONT_UID
			LEFT JOIN ESG_DB.ST_SRC_INFO SSI
				ON SSI.SRC_UID = SCI.SRC_UID
		<where>
			SCI.USE_YN = 'Y'
			AND SCI.CONT_KIND_CD = '40'

			<!-- 검색조건 : 뉴스발간일/등록일/수정일 -->
			<choose>
				<!-- 뉴스발간일 -->
				<when test="schJoinType != null and schJoinType.equals('03')">
					<if test="schStrtDate != null and !schStrtDate.equals('')">
						AND FORMAT(BRI.PBLCN_DT, 'yyyy.MM.dd') <![CDATA[>=]]> #{schStrtDate}
					</if>
					<if test="schEndDate != null and !schEndDate.equals('')">
						AND FORMAT(BRI.PBLCN_DT, 'yyyy.MM.dd') <![CDATA[<=]]> #{schEndDate}
					</if>
				</when>
				<!-- 등록일 -->
				<when test="schJoinType != null and schJoinType.equals('01')">
					<if test="schStrtDate != null and !schStrtDate.equals('')">
						AND FORMAT(DATEADD(HOUR, 9, SCI.FST_INS_DT), 'yyyy.MM.dd') <![CDATA[>=]]>
						#{schStrtDate}
					</if>
					<if test="schEndDate != null and !schEndDate.equals('')">
						AND FORMAT(DATEADD(HOUR, 9, SCI.FST_INS_DT), 'yyyy.MM.dd') <![CDATA[<=]]>
						#{schEndDate}
					</if>
				</when>
				<!-- 수정일 -->
				<when test="schJoinType != null and schJoinType.equals('02')">
					<if test="schStrtDate != null and !schStrtDate.equals('')">
						AND FORMAT(DATEADD(HOUR, 9, SCI.LST_UPD_DT), 'yyyy.MM.dd') <![CDATA[>=]]>
						#{schStrtDate}
					</if>
					<if test="schEndDate != null and !schEndDate.equals('')">
						AND FORMAT(DATEADD(HOUR, 9, SCI.LST_UPD_DT), 'yyyy.MM.dd') <![CDATA[<=]]>
						#{schEndDate}
					</if>
				</when>
			</choose>

			<!-- 검색조건 : 등록자/수정자 -->
			<choose>
				<!-- 등록자 -->
				<when test="schOprtOpt != null and schOprtOpt.equals('01')">
					<if test="schOprtWrd != null and !schOprtWrd.equals('')">
						AND SCI.FST_INS_ID IN (
							SELECT MBR_ID
							FROM ESG_DB.MB_MBR_INFO
							WHERE MBR_NM LIKE CONCAT('%', #{schOprtWrd}, '%')
						)
					</if>
				</when>
				<!-- 수정자 -->
				<when test="schOprtOpt != null and schOprtOpt.equals('02')">
					<if test="schOprtWrd != null and !schOprtWrd.equals('')">
						AND SCI.LST_UPD_ID IN (
							SELECT MBR_ID
							FROM ESG_DB.MB_MBR_INFO
							WHERE MBR_NM LIKE CONCAT(#{schOprtWrd}, '%')
						)
					</if>
				</when>
			</choose>

			<!-- 검색조건 : 뉴스 제목/내용 -->
			<choose>
				<!-- 제목 -->
				<when test="schContentOpt != null and schContentOpt.equals('01')">
					<if test="schContentWrd != null and !schContentWrd.equals('')">
						AND BRI.TTL LIKE CONCAT('%', #{schContentWrd}, '%')
					</if>
				</when>
				<!-- 콘텐츠번호 -->
				<when test="schContentOpt != null and schContentOpt.equals('02')">
					<if test="schContentWrd != null and !schContentWrd.equals('')">
						AND (
							BRI.TTL LIKE CONCAT('%', #{schContentWrd}, '%')
							OR BRI.CN LIKE CONCAT('%', #{schContentWrd}, '%')
						)
					</if>
				</when>
				<!-- 조건없음 안함 = pass -->
				<otherwise>
				</otherwise>
			</choose>

			<!-- 검색조건 : 컨텐츠번호 -->
			<if test="schContentUno != null and !schContentUno.equals('')">
				AND SCI.CONT_UNO LIKE CONCAT('%', #{schContentUno}, '%')
			</if>

			<!-- 검색조건 : 업무 분류 -->
			<if test="schTaskClsfOpt != null and !schTaskClsfOpt.equalsIgnoreCase('ALL')">
				AND SCI.TASK_CLSF_CD <![CDATA[=]]> #{schTaskClsfOpt}
			</if>

			<!-- 검색조건 : 주제 분류 -->
			<if test="schTopicOpt != null and !schTopicOpt.equalsIgnoreCase('ALL')">
				AND SCI.SBJT_GB_CD <![CDATA[=]]> #{schTopicOpt}
			</if>

			<!-- 검색조건 : 전시유형 -->
			<if test="schDpTpRdo != null and !schDpTpRdo.equalsIgnoreCase('ALL')">
				AND SCI.DP_TP_CD <![CDATA[=]]> #{schDpTpRdo}
			</if>

			<!-- 검색조건 : 일부공개대상 -->
			<if test="schRlsTgtChk != null and !schRlsTgtChk.equals('')">
				<foreach item="rlsTgtCd" index="index" collection="schRlsTgtList" separator=""
					open=""
					close="">
					AND CHARINDEX(#{rlsTgtCd}, SCI.RLS_TGT_CD_ARRY) > 0
				</foreach>
			</if>

			<!-- 검색조건 : 검색가능여부 -->
			<if test="schSrchPsbltyRdo != null and !schSrchPsbltyRdo.equalsIgnoreCase('ALL')">
				AND SCI.SRCH_PSBLTY_YN <![CDATA[=]]> #{schSrchPsbltyRdo}
			</if>

			<!-- 검색조건 : ESG 토픽 (메뉴) -->
			<if test="schTpicMnuOpt != null and !schTpicMnuOpt.equalsIgnoreCase('ALL')">
				AND SCI.CONT_UID IN (
				SELECT CONT_UID
				FROM ESG_DB.DP_CONT_TPIC_INFO
				WHERE TPIC_UID IN (
				SELECT TPIC_UID
				FROM ESG_DB.DP_TPIC_INFO
				WHERE TPIC_MNU_CD <![CDATA[=]]> #{schTpicMnuOpt}

				<!-- 검색조건 : ESG 토픽 (토픽명) -->
				<if test="schTpicNmOpt != null and !schTpicNmOpt.equalsIgnoreCase('ALL')">
					AND TPIC_UID <![CDATA[=]]> #{schTpicNmOpt}
				</if>
				)
				)
			</if>

			<!-- 태그키워드 -->
			<if test="schKwrd != null and !schKwrd.equals('')">
				AND SCI.KWRD_ARRY LIKE CONCAT('%', #{schKwrd}, '%')
			</if>
		</where>
		ORDER BY
			SCI.CONT_UID DESC
	</select>

	<update id="updateContSt" parameterType="java.util.List">
		UPDATE ESG_DB.ST_CONT_INFO
		SET
			CONT_ST_CD = '20'
		WHERE CONT_UID IN (
			<foreach collection="list" item="item" separator=",">
				#{item}
			</foreach>
		)
	</update>

	<!-- 뉴스 관리 상세 조회 -->
	<select id="selectNewsView" parameterType="int" resultType="camelcasemap">
		SELECT
			SCI.CONT_UID /* 콘텐츠채번 */
			, SCI.CONT_KIND_CD /* 콘텐츠종류코드 */
			, ESG_DB.fnCommCdNm('CONT_KIND_CD', SCI.CONT_KIND_CD) AS CONT_KIND_CD_NM /* 콘텐츠종류코드명 */
			, SCI.CONT_UNO /* 콘텐츠고유번호 */
		    , SCI.CONT_ST_CD
			, ESG_DB.fnCommCdNm('CONT_ST_CD', SCI.CONT_ST_CD) AS CONT_ST_CD_NM
		    , BRI.TTL
		    , FORMAT(BRI.PBLCN_DT, 'yyyy.MM.dd HH:mm:ss') AS PBLCN_DT
		    , BRI.WRTR_NM
			, SCI.SRC_UID /* 출처채번 */
			, SSI.SRC_NM /* 출처 */
		    , BRI.IMG_URL
		    , BRI.SUMRY
		    , BRI.CN
			, ESG_DB.fnCommCdNm('TASK_CLSF_CD', SCI.TASK_CLSF_CD) AS TASK_CLSF_CD_NM /* 업무분류코드명 */
			, ESG_DB.fnCommCdNm('SBJT_GB_CD', SCI.SBJT_GB_CD) AS SBJT_GB_CD_NM /* 주제분류코드명 */
			, SCI.DP_TP_CD /* 전시유형코드 */
			, SCI.RLS_TGT_CD_ARRY /* 공개대상코드배열 */
			, SCI.PIRD_STNG_USE_YN /* 기간설정사용여부 */
			, SCI.DP_STT_DT /* 전시시작일시 */
			, SCI.DP_END_DT /* 전시종료일시 */
			, SCI.SRCH_PSBLTY_YN /* 검색가능여부 */
			, SCI.KWRD_ARRY /* 키워드배열 */
		FROM
			ESG_DB.ST_CONT_INFO SCI
			JOIN ESG_DB.BT_RSS_INFO BRI
				ON BRI.LINK_URL = SCI.LINK_URL
			LEFT JOIN ESG_DB.ST_SRC_INFO SSI ON
				SSI.SRC_UID = SCI.SRC_UID
		<where>
			SCI.USE_YN = 'Y'
			AND SCI.CONT_KIND_CD = '40'
			AND SCI.CONT_UID = #{contUid}
		</where>
	</select>

	<!-- 뉴스 상세 토픽 목록 조회 -->
	<select id="selectNewsTopicList" parameterType="int" resultType="camelcasemap">
		SELECT
			TPIC_INFO.CONT_UID
			, TPIC_INFO.TPIC_UID
			, TPIC_INFO.DP_SEQ
			, FORMAT(DATEADD(HOUR, 9, TPIC_INFO.FST_INS_DT), 'yyyy.MM.dd HH:mm:ss') AS FST_INS_DT
			, FORMAT(DATEADD(HOUR, 9, TPIC_INFO.LST_UPD_DT), 'yyyy.MM.dd HH:mm:ss') AS LST_UPD_DT
		FROM
			ESG_DB.DP_CONT_TPIC_INFO TPIC_INFO
		WHERE
			TPIC_INFO.DP_YN = 'Y'
			AND TPIC_INFO.CONT_UID = #{contUid}
		ORDER BY
			TPIC_INFO.TPIC_UID, DP_SEQ
	</select>

	<update id="updateNewsInfo" parameterType="camelcasemap">
		UPDATE ESG_DB.ST_CONT_INFO
		SET
			CONT_ST_CD = #{contStCd}
			, DP_TP_CD = #{dpTpCd}
			, DP_YN = (CASE
				WHEN #{dpTpCd} = '30' THEN 'N'
				ELSE 'Y'
			END)
			, RLS_TGT_CD_ARRY = #{rlsTgtCds}
			, PIRD_STNG_USE_YN = #{pirdStngUseYn}
			<if test="dpSttDte != null and !dpSttDte.equals('') and dpSttHh != null and !dpSttHh.equals('') and dpSttMi != null and !dpSttMi.equals('')">
				, DP_STT_DT = CONVERT(datetime, CONVERT(varchar, CONCAT(#{dpSttDte}, ' ', #{dpSttHh}, ':', #{dpSttMi}), 102))
			</if>
			<if test="dpEndDte != null and !dpSttDte.equals('') and dpEndDte != null and !dpEndDte.equals('') and dpEndMi != null and !dpEndMi.equals('')">
				, DP_END_DT = CONVERT(datetime, CONVERT(varchar, CONCAT(#{dpEndDte}, ' ', #{dpEndHh}, ':', #{dpEndMi}), 102))
			</if>
			, SRCH_PSBLTY_YN = #{srchPsbltyYn}
		  	, KWRD_ARRY = #{kwrdArry}
			, LST_UPD_DT = GETDATE()
			, LST_UPD_ID = #{lstUpdId}
		WHERE
			CONT_UID = #{contUid}
	</update>
	<delete id="deleteContTpicInfo" parameterType="int">
		DELETE FROM ESG_DB.DP_CONT_TPIC_INFO
		WHERE CONT_UID = #{contUid}
	</delete>
	<insert id="insertContTpicInfo" parameterType="camelcasemap">
		INSERT INTO ESG_DB.DP_CONT_TPIC_INFO (
											   CONT_UID
											 , TPIC_UID
											 , DP_YN
											 , DP_SEQ
											 , DP_FIX_YN
											 , FST_INS_ID
											 , LST_UPD_ID
		) VALUES (
				   #{contUid}
				 , #{tpicUid}
				 , 'Y'
				 , 999
				 , 'N'
				 , #{fstInsId}
				 , #{lstUpdId}
		)
	</insert>
	
</mapper>