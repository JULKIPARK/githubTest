<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pwc.pwcesg.common.mapper.CommonMapper">

	<!-- 공통 코드 목록 조회 -->
	<select id="selectCodeList" parameterType="string" resultType="camelcasemap">
		SELECT
			GRP_CD /* 그룹코드 */
			, CD /* 코드 */
			, CD_NM /* 코드명 */
			, DP_YN /* 전시여부 */
			, DP_SEQ /* 전시순서 */
			, USE_YN /* 사용여부 */
			, LVL /* 뎁스 */
			, UPR_GRP_CD /* 상위그룹코드 */
			, UPR_CD /* 상위코드 */
			, CD_COMT /* 코드설명 */
			, REF_1_CD /* 참조1코드 */
			, REF_2_CD /* 참조2코드 */
			, REF_3_CD /* 참조3코드 */
			, REF_4_CD /* 참조4코드 */
			, REF_1_CD_NM /* 참조1코드명 */
			, REF_2_CD_NM /* 참조2코드명 */
			, REF_3_CD_NM /* 참조3코드명 */
			, REF_4_CD_NM /* 참조4코드명 */
			, REF_1_CD_COMT /* 참조1코드설명 */
			, REF_2_CD_COMT /* 참조2코드설명 */
			, REF_3_CD_COMT /* 참조3코드설명 */
			, REF_4_CD_COMT /* 참조4코드설명 */
			, FST_INS_DT /* 최초등록일 */
			, FST_INS_ID /* 최초등록아이디 */
			, LST_UPD_DT /* 최종수정일 */
			, LST_UPD_ID /* 최종수정아이디 */
		FROM
			ESG_DB.CM_COMM_CD_INFO
		WHERE
			USE_YN = 'Y' /* 사용여부 */
			AND GRP_CD = #{grpCd} /* 그룹코드 */
		ORDER BY DP_SEQ
	</select>








	<!-- 파일 그룹 ID 세팅-->
	<select id="getIntAtacFileUid" resultType="int">
		UPDATE ESG_DB.SEQUENCES
		SET
			CURRVAL = SEQUENCES.CURRVAL + 1
		OUTPUT
			INSERTED.CURRVAL
		WHERE
			NAME = 'CM_ATAC_FILE_INFO_SQ01'
	</select>

	<!-- 파일 상세 정보 등록 -->
	<insert id="insertAtacDtlInfo" parameterType="camelcasemap">
		INSERT INTO
			ESG_DB.CM_ATAC_DTL_INFO ( ATAC_FILE_UID /* 첨부파일채번 */
									, ATAC_DTL_UID /* 첨부상세채번 */
									, ATAC_TP_CD /* 첨부유형코드 */
									, FILE_PRC_ST_CD /* 파일처리상태코드 */
									, ORGNL_FILE_NM /* 원본파일명 */
									, ORGNL_EXTN /* 원본확장자 */
									, ORGNL_FILE_SZ /* 원본파일크기 */
									, ORGNL_FILE_FPATH /* 원본파일전체경로 */
									, CNVN_FILE_NM /* 변환파일명 */
									, CNVN_EXTN /* 변환확장자 */
									, CNVN_FILE_SZ /* 변환파일크기 */
									, CNVN_FILE_FPATH /* 변환파일전체경로 */
									, TUMNL_FPATH /* 썸네일전체경로 */
									, FST_INS_ID /* 최초등록아이디 */
									, LST_UPD_ID /* 최종수정아이디 */
		)
		VALUES
			( #{atacFileUid} /* 첨부파일채번 */
			, (SELECT
				   ISNULL(MAX(ATAC_DTL_UID), 0) + 1
			   FROM
				   ESG_DB.CM_ATAC_DTL_INFO
			   WHERE
				   ATAC_FILE_UID = #{atacFileUid}) /* 첨부상세채번 */
			, #{atacTpCd} /* 첨부유형코드 */
			, #{filePrcStCd} /* 파일처리상태코드 */
			, #{orgnlFileNm} /* 원본파일명 */
			, #{orgnlExtn} /* 원본확장자 */
			, #{orgnlFileSz} /* 원본파일크기 */
			, #{orgnlFileFpath} /* 원본파일전체경로 */
			, #{cnvnFileNm} /* 변환파일명 */
			, #{cnvnExtn} /* 변환확장자 */
			, #{cnvnFileSz} /* 변환파일크기 */
			, #{cnvnFileFpath} /* 변환파일전체경로 */
			, #{tumnlFpath} /* 썸네일전체경로 */
			, #{fstInsId} /* 최초등록아이디 */
			, #{lstUpdId} /* 최종수정아이디 */
			)
	</insert>

	<!-- 파일 상세 정보 등록 -->
	<update id="updateAtacDtlInfo" parameterType="camelcasemap">
		UPDATE ESG_DB.CM_ATAC_DTL_INFO
		SET
			ORGNL_FILE_NM = #{orgnlFileNm}
			, ORGNL_EXTN = #{orgnlExtn}
			, ORGNL_FILE_SZ = #{orgnlFileSz}
			, ORGNL_FILE_FPATH = #{orgnlFileFpath}
			, CNVN_FILE_NM = #{cnvnFileNm}
			, CNVN_EXTN = #{cnvnExtn}
			, CNVN_FILE_SZ = #{cnvnFileSz}
			, CNVN_FILE_FPATH = #{cnvnFileFpath}
			, LST_UPD_DT = GETDATE()
			, LST_UPD_ID = #{lstUpdId}
		WHERE
			ATAC_FILE_UID = #{atacFileUid}
			AND ATAC_TP_CD = #{atacTpCd}
	</update>
	<update id="updateAtacDtlInfoByEpubPdf" parameterType="camelcasemap">
		UPDATE ESG_DB.CM_ATAC_DTL_INFO
		SET
			TUMNL_FPATH = #{tumnlFpath}
		WHERE
			ATAC_FILE_UID = #{atacFileUid}
			AND ATAC_TP_CD = '10'
	</update>

	<update id="upsertAtacDtlInfo" parameterType="camelcasemap">
		MERGE INTO ESG_DB.CM_ATAC_DTL_INFO AS Target
		USING (VALUES (#{atacFileUid}, #{atacTpCd})) AS Source (ATAC_FILE_UID, ATAC_TP_CD)
		ON Target.ATAC_FILE_UID = Source.ATAC_FILE_UID AND Target.ATAC_TP_CD = Source.ATAC_TP_CD
		WHEN MATCHED THEN
			UPDATE SET
				ORGNL_FILE_NM = #{orgnlFileNm}
				, ORGNL_EXTN = #{orgnlExtn}
				, ORGNL_FILE_SZ = #{orgnlFileSz}
				, ORGNL_FILE_FPATH = #{orgnlFileFpath}
				, CNVN_FILE_NM = #{cnvnFileNm}
				, CNVN_EXTN = #{cnvnExtn}
				, CNVN_FILE_SZ = #{cnvnFileSz}
				, CNVN_FILE_FPATH = #{cnvnFileFpath}
				, LST_UPD_DT = GETDATE()
				, LST_UPD_ID = #{lstUpdId}
		WHEN NOT MATCHED THEN
			INSERT (ATAC_FILE_UID, ATAC_DTL_UID, ATAC_TP_CD, FILE_PRC_ST_CD, ORGNL_FILE_NM, ORGNL_EXTN, ORGNL_FILE_SZ, ORGNL_FILE_FPATH, CNVN_FILE_NM, CNVN_EXTN, CNVN_FILE_SZ, CNVN_FILE_FPATH, FST_INS_DT, FST_INS_ID, LST_UPD_DT, LST_UPD_ID)
			VALUES (
			        #{atacFileUid}
				   , (SELECT ISNULL(MAX(ATAC_DTL_UID), 0) + 1 FROM ESG_DB.CM_ATAC_DTL_INFO WHERE ATAC_FILE_UID = #{atacFileUid})
				   , #{atacTpCd}
					, '30'
				   , #{orgnlFileNm}
				   , #{orgnlExtn}
				   , #{orgnlFileSz}
				   , #{orgnlFileFpath}
				   , #{cnvnFileNm}
				   , #{cnvnExtn}
				   , #{cnvnFileSz}
				   , #{cnvnFileFpath}, GETDATE(), #{lstUpdId}, GETDATE(), #{lstUpdId});

	</update>
	
	<!-- 하위 공통 코드 목록 조회 -->
	<select id="selectUnderCodeList" parameterType="camelcasemap" resultType="camelcasemap">
		/* selectCodeTermsList */
		SELECT
			GRP_CD /* 그룹코드 */
			, CD /* 코드 */
			, CD_NM /* 코드명 */
			, DP_YN /* 전시여부 */
			, DP_SEQ /* 전시순서 */
			, USE_YN /* 사용여부 */
			, LVL /* 뎁스 */
			, UPR_GRP_CD /* 상위그룹코드 */
			, UPR_CD /* 상위코드 */
			, CD_COMT /* 코드설명 */
			, REF_1_CD /* 참조1코드 */
			, REF_2_CD /* 참조2코드 */
			, REF_3_CD /* 참조3코드 */
			, REF_4_CD /* 참조4코드 */
			, REF_1_CD_NM /* 참조1코드명 */
			, REF_2_CD_NM /* 참조2코드명 */
			, REF_3_CD_NM /* 참조3코드명 */
			, REF_4_CD_NM /* 참조4코드명 */
			, REF_1_CD_COMT /* 참조1코드설명 */
			, REF_2_CD_COMT /* 참조2코드설명 */
			, REF_3_CD_COMT /* 참조3코드설명 */
			, REF_4_CD_COMT /* 참조4코드설명 */
			, FST_INS_DT /* 최초등록일 */
			, FST_INS_ID /* 최초등록아이디 */
			, LST_UPD_DT /* 최종수정일 */
			, LST_UPD_ID /* 최종수정아이디 */
		FROM
			ESG_DB.CM_COMM_CD_INFO
		WHERE
			USE_YN = 'Y' /* 사용여부 */
			AND GRP_CD = #{grpCd} /* 그룹코드 */
			AND UPR_CD = #{uprCd} /* 상위코드 */
		ORDER BY DP_SEQ
	</select>

	<!-- 파일 목록 조회-->
	<select id="selectFileList" parameterType="camelcasemap" resultType="camelcasemap">
		/* selectFileList */
		SELECT
		ATAC_FILE_UID /* 첨부파일채번 */
		, ATAC_DTL_UID /* 첨부상세채번 */
		, ATAC_TP_CD /* 첨부유형코드 */
		, FILE_PRC_ST_CD /* 파일처리상태코드 */
		, DP_YN /* 전시여부 */
		, USE_YN /* 사용여부 */
		, ORGNL_FILE_NM /* 원본파일명 */
		, ORGNL_EXTN /* 원본확장자 */
		, ORGNL_FILE_SZ /* 원본파일크기 */
		, (CASE WHEN ORGNL_FILE_SZ <![CDATA[<]]> 1024 THEN ORGNL_FILE_SZ || ' bytes'
		WHEN ORGNL_FILE_SZ <![CDATA[<]]> 1024*1024 THEN ROUND(ORGNL_FILE_SZ/1024, 2) || ' Kb'
		WHEN ORGNL_FILE_SZ <![CDATA[<]]> 1024*1024*1024 THEN ROUND(ORGNL_FILE_SZ/1024/1024, 2) || '
		Mb'
		ELSE ROUND(ORGNL_FILE_SZ/1024/1024/1024, 2) || ' Gb' END) AS FILE_SIZE
		, ORGNL_FILE_FPATH /* 원본파일전체경로 */
		, CNVN_FILE_NM /* 변환파일명 */
		, CNVN_EXTN /* 변환확장자 */
		, CNVN_FILE_SZ /* 변환파일크기 */
		, CNVN_FILE_FPATH /* 변환파일전체경로 */
		, TUMNL_FPATH /* 썸네일전체경로 */
		FROM CM_ATAC_DTL_INFO
		WHERE ATAC_FILE_UID = #{atacFileUid} /* 첨부파일채번 */
		<if test="atacDtlUid != null and !fatacDtlUid.equals('')">
			AND ATAC_DTL_UID = #{atacDtlUid} /* 첨부상세채번 */
		</if>
		ORDER BY ATAC_FILE_UID, ATAC_DTL_UID
	</select>

	<!-- 파일 그룹 ID 세팅-->
	<select id="getAtacFileUid" resultType="string">
		SELECT NEXTVAL('CM_ATAC_FILE_INFO_SQ01') ATAC_FILE_UID
	</select>

	<!-- 파일 그룹 정보 등록 -->
	<insert id="insertFileGroup" parameterType="camelcasemap">
		/* insertFileGroup */
		INSERT INTO
			CM_ATAC_FILE_INFO( ATAC_FILE_UID /* 첨부파일채번 */
							 , FST_INS_DT /* 최초등록일 */
							 , FST_INS_ID /* 최초등록아이디 */
		)
		VALUES
			( #{atacFileUid} /* 첨부파일채번 */
			, CURRENT_TIMESTAMP /* 최초등록일 */
			, #{fstInsId} /* 최초등록아이디 */
			)
	</insert>

	<!-- 파일 그룹 정보 삭제 -->
	<delete id="deleteFileGroup" parameterType="camelcasemap">
		/* deleteFileGroup */
		DELETE
		FROM
			CM_ATAC_FILE_INFO
		WHERE
			ATAC_FILE_UID = #{atacFileUid}
	</delete>

	<!-- 파일 상세 번호 MAX+1값 조회-->
	<select id="getMaxFileNo" parameterType="String" resultType="int">
		/* getMaxFileNo */
		SELECT
			IFNULL(MAX(ATAC_DTL_UID), 0) + 1 ATAC_DTL_UID
		FROM
			CM_ATAC_DTL_INFO
		WHERE
			ATAC_FILE_UID = #{atacFileUid}
	</select>

	<!-- 파일 상세 정보 삭제 -->
	<delete id="deleteFileDetail" parameterType="camelcasemap">
		/* deleteFileDetail */
		DELETE FROM CM_ATAC_DTL_INFO
		WHERE ATAC_FILE_UID = #{atacFileUid}
		<if test="atacDtlUid != null and !atacDtlUid.equals('')">
			AND ATAC_DTL_UID = #{atacDtlUid}
		</if>
	</delete>

	<!-- 파일 그룹 정보 등록 -->
	<insert id="insertAtacFileInfo" parameterType="camelcasemap">
		/* order="BEFORE" 삽입 전에 조회 */
		/* insertAtacFileInfo */
		INSERT INTO
			CM_ATAC_FILE_INFO( ATAC_FILE_UID /* 첨부파일채번 */
							 , FST_INS_DT /* 최초등록일 */
							 , FST_INS_ID /* 최초등록아이디 */
		)
		VALUES
			( #{atacFileUid} /* 첨부파일채번 */
			, CURRENT_TIMESTAMP /* 최초등록일 */
			, #{fstInsId} /* 최초등록아이디 */
			)
	</insert>

	<!-- 파일 상세 번호 MAX+1값 조회-->
	<select id="getAtacDtlUid" resultType="string">
		/* getAtacDtlUid */
		SELECT NEXTVAL('CM_ATAC_DTL_INFO_SQ01') AS ATAC_DTL_UID
	</select>

</mapper>