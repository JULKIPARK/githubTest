<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{frontoffice/layout/subwrapLayout}">
<th:block layout:fragment="script">
    <script type="text/javascript">
    	let tabId = "tabId"+'[[${tabId}]]';
        let chartTrends;
        let chartTopicTrends;
        let chartTopicDetail;
        const chartTopicTrendsColorCodes = ['#d04a01', '#f1b841', '#e0301d', '#eb8d00', '#6a1ce2', '#4eacf1', '#4cb421'];
        $(function () {
    		/*<![CDATA[*/

    		/*]]>*/
            fnInitView();
            fnInitData();
            fnInitEvent();
        });
        const fnInitView = () => {
            initChartTrends();
            initChartTopicTrends();
            initChartTopicDetail();
        };
        const fnInitData = () => {



            getKeywords();
            getParentTopicTrendHits();
            onClickTopicDetailsHandler();

        };
        const fnInitEvent = () => {
            //
        };
        const initChartTrends = () => {
            chartTrends = new Chart(
                document.querySelector('#chartTrends').getContext('2d'),
                {
                    type: 'bar',
                    options: {
                        legend:{
                            display:false
                        },
                    },
                    data: {
                        labels: [],
                        datasets: [{
                            label: '뉴스건수',
                            data: [],
                        }]
                    },
                }
            );
        };
        const initChartTopicTrends = () => {
            chartTopicTrends = new Chart(
                document.querySelector('#chartTopicTrends').getContext('2d'),
                {
                    type: 'pie',
                    options: {
                        legend: {
                            display: false,
                            // position: 'top',
                        },
                    },
                    data: {
                        labels: [],
                        datasets: [{
                            label: '',
                            data: [],
                        }]
                    },
                }
            );
        };
        const initChartTopicDetail = () => {
            chartTopicDetail = new Chart(
                document.querySelector('#chartTopicDetail').getContext('2d'),
                {
                    type: 'bar',
                    options: {
                        legend: {
                            position: 'bottom',
                        },
                        responsive: true,
                        scales: {
                            xAxes: [{
                                stacked: true,
                            }],
                            yAxes: [{
                                stacked: true
                            }]
                        }
                    },
                    data: {
                        labels: ['test', 'aaa', 'tttt'],
                        datasets: [{
                            label: 'd1',
                            data: [1, 2, 3],
                            backgroundColor: chartTopicTrendsColorCodes[0]
                        }, {
                            label: 'd2',
                            data: [5,4, 3],
                            backgroundColor: chartTopicTrendsColorCodes[1]
                        }]
                    },
                }
            );
        };
        const getKeywords = () => {
            $.ajax({
                url:"/news-trend/getKeywords",
                type: 'post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ }),
                success: (data) => {
                    data?.keywords && generateKeywordElement(data.keywords);
                    // data?.keywords && getNews(data.keywords[0].keywordUid);
                    data?.keywords && getTrends(data.keywords[0].keywordUid);
                }
            });
        };
        const generateKeywordElement = (list) => {
            const _$liTemplate = document.createElement('li');
            _$liTemplate.innerHTML = `<button type="button" class="btn-rd-wh"><span></span></button>`;

            const _$ul = document.createElement('ul')
            _$ul.classList.add('_ulKeywords');
            _$ul.classList.add('keyword-wrap');
            _$ul.classList.add('current-wrap');
            let $ck;
            list.forEach((item, index) => {
                const _$li = _$liTemplate.cloneNode(true);
                _$li.querySelector('button').id = `tabId${index+1}`;
                _$li.querySelector('button').classList.add('_btnKeyword');
                _$li.querySelector('button').dataset.keywordUid = item.keywordUid;
                _$li.querySelector('button').onclick = () => { onClickKeywordHandler(item.keywordUid); };
                _$li.querySelector('span').innerText= `${index+1}위. ${item.name}`;
                if(_$li.querySelector('button').id == tabId) {
                    $ck = _$li.querySelector('button');
                }
                _$ul.append(_$li);



            });

            document.querySelector('._ulKeywords').replaceWith(_$ul);
            $ck.click();
        };
        const getNews = (keywordUid) => {
            $.ajax({
                url:"/news-trend/getNews",
                type: 'post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ keywordUid }),
                success: (data) => {
                    data?.news && generateNewsElement(data.news);
                }
            });
        };
        const generateNewsElement = (list) => {
            const _$liTemplate = document.createElement('li');
            _$liTemplate.innerHTML = `
                <a href="#" target="_blank">
                    <div class="num"></div>
                    <div class="subj"></div>
                    <div class="date"></div>
                </a>
            `;

            const _$ul = document.createElement('ul')
            _$ul.classList.add('_ulNews');
            _$ul.classList.add('hit-news');
            list.forEach((item, index) => {
                const _$li = _$liTemplate.cloneNode(true);
                _$li.querySelector('a').href = item.providerLinkPage.startsWith('http')?item.providerLinkPage:'http://'+item.providerLinkPage;
                _$li.querySelector('.num').innerText = index + 1;
                _$li.querySelector('.subj').innerText = '[' + item.provider + '] ' + item.title;
                _$li.querySelector('.date').innerText = item.publishedAt.split('T')[0].replaceAll('-', '.');
                _$ul.append(_$li);
            });

            document.querySelector('._ulNews').replaceWith(_$ul);
        };
        const getTrends = (keywordUid) => {
            $.ajax({
                url:"/news-trend/getTrends",
                type: 'post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ keywordUid }),
                success: (data) => {
                    data?.trends && setChartTrends(data.trends);
                }
            });
        };
        const setChartTrends = (list) => {
            chartTrends.data = {
                labels: list.map((item, index) => {
                    return item.label.substring(4, 6) + '월 ' + item.label.substring(6, 8) + '일';
                }),
                datasets: [{
                    label: '뉴스건수',
                    backgroundColor: '#d04b03',
                    data: list.map((item, index) => item.hits),
                }]
            }
            chartTrends.update();
        };
        const onClickKeywordHandler = (keywordUid) => {
            document.querySelectorAll('._ulKeywords > li > button').forEach((item, index) => {
                item.classList.remove('current');
                if(item.dataset.keywordUid === `${keywordUid}`) {
                    item.classList.add('current');
                }
            });
            getNews(keywordUid);
            getTrends(keywordUid);
        };
        const getParentTopicTrendHits = () => {
            $.ajax({
                url:"/news-trend/getParentTopicTrendHits",
                type: 'post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ }),
                success: (data) => {
                    data?.topicTrends && setChartTopicTrends(data.topicTrends);
                    data?.topicTrends && setTopicTrendsElement(data.topicTrends);
                }
            });
        };
        const setChartTopicTrends = (list) => {
            chartTopicTrends.data = {
                labels: list.map((item, index) => {
                    return item.topic;
                }),
                datasets: [{
                    label: '',
                    data: list.map((item, index) => item.hits),
                    backgroundColor: chartTopicTrendsColorCodes
                }]
            }
            chartTopicTrends.update();
        };
        const setTopicTrendsElement = (list) => {
            const totalHits = list.reduce((ac, cv, ci, arr) => ac + cv.hits, 0);
            list.forEach((item, index) => {
                const $el = document.querySelector(`td[data-topic-uid="${item.topicUid}"]`);
                $el.innerHTML = parseInt((item.hits * 100) / totalHits, 10) + '%';
            })
        }
        const getParentTopicDetails = (parentTopicUid = 1) => {
            $.ajax({
                url:"/news-trend/getParentTopicDetails",
                type: 'post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ parentTopicUid }),
                success: (data) => {
                    data?.details && setChartTopicDetailData(data.details);
                }
            });
        };
        const setChartTopicDetailData = (list) => {
            convertToChartDateForTopicDetails(list);
        }
        const convertToChartDateForTopicDetails = (list) => {
            const labels = Array.from({ length: 7 }, (_, i) => {
                const date = new Date(Date.now() - 86400000 * (7 - i));
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                return `${y}${m}${d}`;
            })
            // const labels = [];
            const topics = [];
            const labelsMap = Object();
            list.forEach((item, index) => {
                // if(labels.indexOf(item.label) < 0) {
                //    labels.push(item.label);
                // }
                if(topics.map(item => item.topic).indexOf(item.topic) < 0) {
                    topics.push({ topic: item.topic, topicUid: item.topicUid });
                }
                labelsMap[item.label] = {...(labelsMap[item.label] ?? {}), ...{[`${item.topicUid}`]: item}};
            });
            const datasets = topics.map((item, index) => {
                return {
                    label: item.topic,
                    data: labels.map((subItem, index) => labelsMap[subItem]?.[`${item.topicUid}`]?.hits ?? 0 ),
                    backgroundColor: chartTopicTrendsColorCodes[index % chartTopicTrendsColorCodes.length]
                }
            });
            chartTopicDetail.data = {
                labels: labels.map(item => item.substring(4, 6) + '월 ' + item.substring(6, 8) + '일'),
                datasets: datasets
            }
            chartTopicDetail.update();
        };
        const onClickTopicDetailsHandler = (topicUid = 1) => {
            document.querySelectorAll('._btnGetTrendDetails').forEach(item => {
                item.classList.remove('current');
                if(item.dataset.topicUid === `${topicUid}`) {
                    item.classList.add('current');
                }
            });
            getParentTopicDetails(topicUid);
        };
    </script>
</th:block>

<div layout:fragment="content">
    <!-- content -->
    <section id="container" class="sub content">
        <div class="sub-title-a">
            <div class="ct">
                <div class="tit">ESG 뉴스 트렌드</div>
                <div class="subs">100여개 언론사의 최근 7일 간 뉴스정보를 분석하여 ESG 키워드를 도출하고 관련 뉴스를 제공합니다.</div>
            </div>
            <div class="bgBack"></div>
            <div class="bg"><img src="/assets/img/common/bg_tit.png"></div>
        </div>

        <div class="newstrend default-width">
            <section class="newsKeyword">
                <h4 class="tit-line-left">뉴스 키워드 분석</h4>

                <div class="tab-scroll">
                    <ul class="_ulKeywords keyword-wrap current-wrap w100">
                        <li>
                            <button type="button" id="tabId1" class="current btn-rd-wh"><span>1위. ...</span></button>
                        </li>
                        <li>
                            <button type="button" id="tabId2" class="btn-rd-wh"><span>2위. ...</span></button>
                        </li>
                        <li>
                            <button type="button" id="tabId3" class="btn-rd-wh"><span>3위. ...</span></button>
                        </li>
                        <li>
                            <button type="button" id="tabId4" class="btn-rd-wh"><span>4위. ...</span></button>
                        </li>
                        <li>
                            <button type="button" id="tabId5" class="btn-rd-wh"><span>5위. ...</span></button>
                        </li>
                    </ul>
                </div>

                <div class="tab-cont">
                    <div id="tab1" class="contMain" style="display:block;">
                        <dl class="keyword-list-a">
                            <dd>
                                <div class="tit-a">
                                    <div class="tit">키워드 관련 Hit 뉴스</div>
                                    <div class="op-a art">※ 조회 수 기준</div>
                                </div>

                                <ul class="_ulNews hit-news">
                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <div class="num">.</div>
                                            <div class="subj">...</div>
                                            <div class="date">...</div>
                                        </a>
                                    </li>
                                </ul>
                            </dd>

                            <dd>
                                <div class="tit-a">
                                    <div class="tit">키워드 관련 뉴스 추이</div>
                                    <div class="op-a sign">뉴스건수</div>
                                </div>

                                <div class="chart"><canvas height="230px" id="chartTrends"></canvas></div>
                            </dd>
                        </dl>
                    </div>

                    <div id="tab2" class="contMain" style="display:none;">
                        tab2
                    </div>

                    <div id="tab3" class="contMain" style="display:none;">
                        tab3
                    </div>

                    <div id="tab4" class="contMain" style="display:none;">
                        tab4
                    </div>

                    <div id="tab5" class="contMain" style="display:none;">
                        tab5
                    </div>
                </div>

            </section>

            <section class="topic">
                <h4 class="tit-line-left">ESG 토픽별 뉴스 추이</h4>
                <div class="arl-box">ESG 주요 토픽별 뉴스 기사 건수 변화를 통해 최근 어떤 토픽과 관련된 사건이나 관심이 증가했는지 확인할 수 있습니다.</div>
                <dl class="chart-list">
                    <dd>
                        <div class="chart"><canvas height="330px" id="chartTopicTrends"></canvas></div>
                        <table cellpadding="0" cellspacing="0">
                            <thead>
                            <tr>
                                <th>구분</th>
                                <th>비중</th>
                            </tr>
                            </thead>

                            <tbody class="_tbodyTopicTrends">
                            <tr>
                                <td><span class="red"></span>환경</td>
                                <td class="right" data-topic-uid="1">29%</td>
                            </tr>

                            <tr>
                                <td><span class="yellow"></span>사회</td>
                                <td class="right" data-topic-uid="2">28%</td>
                            </tr>

                            <tr>
                                <td><span class="hoppink"></span>거버넌스</td>
                                <td class="right" data-topic-uid="3">15%</td>
                            </tr>

                            <tr>
                                <td><span class="orange"></span>금융</td>
                                <td class="right" data-topic-uid="4">7%</td>
                            </tr>

                            <tr>
                                <td><span class="purple"></span>ESG Tax</td>
                                <td class="right" data-topic-uid="5">4%</td>
                            </tr>

                            <tr>
                                <td><span class="blue"></span>ESG Deal</td>
                                <td class="right" data-topic-uid="6">3%</td>
                            </tr>

                            <tr>
                                <td><span class="green"></span>ESG 공시</td>
                                <td class="right" data-topic-uid="7">13%</td>
                            </tr>
                            </tbody>
                        </table>
                    </dd>

                    <dd>
                        <div class="tab-scroll">
                            <ul class="keyword-wrap current-wrap">
                                <li>
                                    <button type="button" id="tabId6" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="1" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>환경(E)</span>
                                    </button>
                                </li>
                                <li>
                                    <button type="button" id="tabId7" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="2" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>사회(S)</span></button>
                                </li>
                                <li>
                                    <button type="button" id="tabId8" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="3" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>거버넌스(G)</span></button>
                                </li>
                                <li>
                                    <button type="button" id="tabId9" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="4" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>금융</span></button>
                                </li>
                                <li>
                                    <button type="button" id="tabId10" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="5" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>ESG Tax</span></button>
                                </li>
                                <li>
                                    <button type="button" id="tabId10" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="6" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>ESG Deal</span></button>
                                </li>
                                <li>
                                    <button type="button" id="tabId10" class="_btnGetTrendDetails btn-rd-wh" data-topic-uid="7" onclick="onClickTopicDetailsHandler(this.dataset['topicUid'])"><span>ESG 공시</span></button>
                                </li>
                            </ul>
                        </div>

                        <div class="chart"><canvas height="260px" id="chartTopicDetail"></canvas></div>
                    </dd>
                </dl>
            </section>
        </div>
    </section>
    <!-- //content -->
</div>
</html>
